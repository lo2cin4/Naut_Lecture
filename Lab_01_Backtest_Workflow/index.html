<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Lab 01ï¼šå¾é›¶åˆ°å›æ¸¬ â€” NautilusTrader æ•™æ</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;family=Noto+Sans+TC:wght@300;400;500;700&amp;family=JetBrains+Mono:wght@400;500&amp;display=swap" rel="stylesheet"/>
<link href="../assets/style.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
<!-- Language Toggle -->
<style>
.lang-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    background: rgba(43, 48, 59, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 6px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    text-decoration: none;
    color: var(--text-secondary, #A0AEC0);
    font-size: 0.9rem;
    font-weight: 500;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
.lang-toggle:hover {
    background: rgba(60, 65, 75, 0.9);
    color: var(--text-primary, #F7FAFC);
    border-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}
.lang-toggle span.active {
    color: #64ffda;
    font-weight: 600;
}
.lang-toggle svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
}
</style>
<a class="lang-toggle" href="../en/Lab_01_Backtest_Workflow/index.html" title="Switch to English">
<svg viewbox="0 0 24 24"><path d="M12.87 15.07l-2.54-2.51.03-.03A17.52 17.52 0 0014.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>
<span>EN / <span class="active">ä¸­</span></span>
</a>

<!-- Language Toggle -->


<div class="page-wrapper">
<nav class="sidebar">
<div class="sidebar-header">
<div class="sidebar-logo"><span class="icon">ğŸš</span> NautilusTrader æ•™æ</div>
</div>
<div class="sidebar-nav">
<div class="nav-section">
<div class="nav-section-title">ç¬¬é›¶éšæ®µï¼šèµ·æ­¥</div>
</div>
<a class="nav-item" href="../Module_00_Getting_Started/index.html"><span class="nav-num">00</span>
                    ç’°å¢ƒå®‰è£</a>
<div class="nav-section">
<div class="nav-section-title">ç¬¬ä¸€éšæ®µï¼šå…¨å±€èªè­˜</div>
</div>
<!-- ... omitted for brevity in template, will be filled by script ... -->
<a class="nav-item" href="../Module_01_Why_NautilusTrader/index.html"><span class="nav-num">01</span>
                    ç‚ºä»€éº¼é¸æ“‡ NT</a>
<a class="nav-item" href="../Module_02_Architecture_Overview/index.html"><span class="nav-num">02</span>
                    æ¶æ§‹é³¥ç°åœ–</a>
<a class="nav-item" href="../Module_03_Design_Philosophy/index.html"><span class="nav-num">03</span>
                    è¨­è¨ˆå“²å­¸</a>
<div class="nav-section">
<div class="nav-section-title">ç¬¬äºŒéšæ®µï¼šæ ¸å¿ƒçµ„ä»¶</div>
</div>
<a class="nav-item" href="../Module_04_Domain_Model/index.html"><span class="nav-num">04</span> é ˜åŸŸæ¨¡å‹</a>
<a class="nav-item" href="../Module_05_MessageBus/index.html"><span class="nav-num">05</span> æ¶ˆæ¯ç¸½ç·š</a>
<a class="nav-item" href="../Module_05B_Data_Management/index.html"><span class="nav-num">05B</span>
                    æ•¸æ“šç®¡ç†</a>
<a class="nav-item" href="../Module_06_Cache/index.html"><span class="nav-num">06</span> ç·©å­˜ç³»çµ±</a>
<a class="nav-item" href="../Module_07_DataEngine/index.html"><span class="nav-num">07</span> æ•¸æ“šå¼•æ“</a>
<a class="nav-item" href="../Module_08_ExecutionEngine/index.html"><span class="nav-num">08</span>
                    åŸ·è¡Œå¼•æ“</a>
<a class="nav-item" href="../Module_09_RiskEngine/index.html"><span class="nav-num">09</span> é¢¨æ§å¼•æ“</a>
<a class="nav-item" href="../Module_10_Portfolio/index.html"><span class="nav-num">10</span> æŠ•è³‡çµ„åˆ</a>
<div class="nav-section">
<div class="nav-section-title">ç¬¬ä¸‰éšæ®µï¼šå¯¦æˆ°æ‡‰ç”¨</div>
</div>
<a class="nav-item" href="../Module_11_Strategy_Development/index.html"><span class="nav-num">11</span>
                    ç­–ç•¥é–‹ç™¼</a>
<a class="nav-item" href="../Module_12_Backtest_And_Live/index.html"><span class="nav-num">12</span>
                    å›æ¸¬èˆ‡å¯¦ç›¤</a>
<div class="nav-section">
<div class="nav-section-title">ç¬¬å››éšæ®µï¼šé€²éšæ“´å±•</div>
</div>
<a class="nav-item" href="../Module_13_Adapters_Extensions/index.html"><span class="nav-num">13</span>
                    é©é…å™¨èˆ‡æ“´å±•</a>
<a class="nav-item" href="../Module_14_Configuration/index.html"><span class="nav-num">14</span>
                    é…ç½®ç³»çµ±æ·±æ½›</a>
<a class="nav-item" href="../Module_15_Live_Advanced/index.html"><span class="nav-num">15</span>
                    å¯¦ç›¤éƒ¨ç½²é€²éš</a>
<a class="nav-item" href="../Module_16_Accounting_Risk/index.html"><span class="nav-num">16</span>
                    æœƒè¨ˆèˆ‡é¢¨æ§</a>
<a class="nav-item" href="../Module_17_Advanced_Topics/index.html"><span class="nav-num">17</span>
                    é€²éšä¸»é¡Œ</a>
<div class="nav-section">
<div class="nav-section-title">ç¬¬äº”éšæ®µï¼šå‹•æ‰‹ Lab</div>
</div>
<a class="nav-item active" href="index.html"><span class="nav-num">L1</span> Lab 01</a>
<a class="nav-item" href="../Lab_02_Binance_Sandbox/index.html"><span class="nav-num">L2</span> Lab
                    02</a>
<a class="nav-item" href="../Lab_03_Custom_Strategy/index.html"><span class="nav-num">L3</span> Lab
                    03</a>
</div>
</nav>
<div class="main-content">
<div class="top-bar">
<button aria-label="é–‹å•Ÿé¸å–®" class="menu-toggle">â˜°</button>
<div class="breadcrumb"><a href="../index.html">é¦–é </a><span class="separator">â€º</span>ç¬¬äº”éšæ®µ<span class="separator">â€º</span>Lab 01</div>
</div>
<div class="content-container">
<span class="phase-label phase-5">ç¬¬äº”éšæ®µï¼šå‹•æ‰‹ Lab</span>
<h1>Lab 01ï¼šå¾é›¶åˆ°å›æ¸¬<span class="subtitle">å‹•æ‰‹å¯¦ä½œï¼šå»ºç«‹ä½ çš„ç¬¬ä¸€å€‹å®Œæ•´çš„ NautilusTrader å°ˆæ¡ˆ</span></h1>
<!-- ==================== -->
<h2>ç›®æ¨™</h2>
<p>åœ¨é€™å€‹ Lab ä¸­ï¼Œä½ å°‡å¾ä¸€å€‹ç©ºç™½è³‡æ–™å¤¾é–‹å§‹ï¼Œä¸€æ­¥æ­¥æ­å»ºå‡ºä¸€å€‹å¯ä»¥é‹è¡Œçš„ EMA äº¤å‰ç­–ç•¥å›æ¸¬ç³»çµ±ã€‚ä½ å°‡å­¸æœƒï¼š</p>
<ol>
<li>å°ˆæ¡ˆçµæ§‹çš„æœ€ä½³å¯¦è¸</li>
<li>æº–å‚™ CSV æ•¸æ“šä¸¦è½‰æ›ç‚º Parquet</li>
<li>ç·¨å¯« DataCatalog é…ç½®</li>
<li>ç·¨å¯« EMA Cross ç­–ç•¥</li>
<li>é…ç½® BacktestEngine ä¸¦é‹è¡Œå›æ¸¬</li>
<li>ç”Ÿæˆ Tearsheet åˆ†æçµæœ</li>
</ol>
<div class="callout callout-info">
<div class="callout-title">ğŸ› ï¸ æº–å‚™å·¥ä½œ</div>
<p>è«‹ç¢ºä¿ä½ å·²ç¶“æŒ‰ç…§ <a href="../Module_00_Getting_Started/index.html">Module 00</a> å®‰è£å¥½äº† Python ç’°å¢ƒå’Œ
                        NautilusTraderã€‚</p>
</div>
<!-- ==================== -->
<h2>æ­¥é©Ÿ 1ï¼šå»ºç«‹å°ˆæ¡ˆçµæ§‹</h2>
<p>åœ¨ä½ çš„å·¥ä½œç›®éŒ„ï¼ˆä¾‹å¦‚ <code>my_quant_project</code>ï¼‰ä¸­ï¼Œå»ºç«‹ä»¥ä¸‹æ–‡ä»¶å¤¾å’Œæ–‡ä»¶ï¼š</p>
<pre><code class="language-bash">my_quant_project/
â”œâ”€â”€ data/               # å­˜æ”¾ CSV åŸå§‹æ•¸æ“š
â”œâ”€â”€ catalog/            # å­˜æ”¾ Parquet æ•¸æ“š
â”œâ”€â”€ strategies/         # å­˜æ”¾ç­–ç•¥ä»£ç¢¼
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ ema_cross.py    # æˆ‘å€‘çš„ç­–ç•¥æ–‡ä»¶
â”œâ”€â”€ config.py           # å…¨å±€é…ç½®
â””â”€â”€ run_backtest.py     # å›æ¸¬å•Ÿå‹•è…³æœ¬
</code></pre>
<!-- ==================== -->
<h2>æ­¥é©Ÿ 2ï¼šæº–å‚™æ•¸æ“š (CSV â†’ Parquet)</h2>
<p>NautilusTrader æ¨è–¦ä½¿ç”¨ Partquet æ ¼å¼ã€‚æˆ‘å€‘å¯«ä¸€å€‹è…³æœ¬æŠŠ CSV è½‰æˆ Parquetã€‚</p>
<p>å‡è¨­ä½ æœ‰ä¸€å€‹ <code>data/ETHUSDT.csv</code>ï¼Œæ ¼å¼å¦‚ä¸‹ï¼ˆå¦‚æœæ˜¯ Binance æ•¸æ“šï¼‰ï¼š</p>
<pre>timestamp,open,high,low,close,volume,...
1609459200000,736.42,739.00,736.00,737.95,123.45,...</pre>
<p>å‰µå»º <code>convert_data.py</code>ï¼š</p>
<pre><code class="language-python">import pandas as pd
from nautilus_trader.model.data import Bar, BarType
from nautilus_trader.model.enums import BarAggregation, PriceType
from nautilus_trader.model.instruments import InstrumentId
from nautilus_trader.persistence.catalog import ParquetDataCatalog

def convert_csv_to_parquet():
    # 1. è®€å– CSV
    df = pd.read_csv("data/ETHUSDT.csv")
    
    # 2. ç‚ºæ¯ä¸€è¡Œå‰µå»º Bar å°è±¡ (é€™ä¸€æ­¥æ¯”è¼ƒæ…¢ï¼Œä½†åªéœ€åšä¸€æ¬¡)
    bars = []
    instrument_id = InstrumentId.from_str("ETHUSDT.BINANCE")
    bar_type = BarType.from_str("ETHUSDT.BINANCE-1-MINUTE-LAST-EXTERNAL")
    
    for _, row in df.iterrows():
        bar = Bar(
            bar_type=bar_type,
            ts_event=int(row["timestamp"] * 1_000_000), # æ¯«ç§’è½‰ç´ç§’
            ts_init=int(row["timestamp"] * 1_000_000),
            open=float(row["open"]),
            high=float(row["high"]),
            low=float(row["low"]),
            close=float(row["close"]),
            volume=float(row["volume"]),
        )
        bars.append(bar)

    # 3. å¯«å…¥ Catalog
    catalog = ParquetDataCatalog("./catalog")
    catalog.write_data(bars)
    print("æ•¸æ“šè½‰æ›å®Œæˆï¼")

if __name__ == "__main__":
    convert_csv_to_parquet()</code></pre>
<!-- ==================== -->
<h2>æ­¥é©Ÿ 3ï¼šç·¨å¯«ç­–ç•¥ (strategies/ema_cross.py)</h2>
<pre><code class="language-python">from decimal import Decimal
from nautilus_trader.trading.strategy import Strategy
from nautilus_trader.config import StrategyConfig
from nautilus_trader.indicators.average.ema import ExponentialMovingAverage
from nautilus_trader.model.enums import OrderSide

class EmaCrossConfig(StrategyConfig):
    instrument_id: str
    fast_period: int = 10
    slow_period: int = 20
    trade_size: str = "0.01"

class EmaCrossStrategy(Strategy):
    def __init__(self, config: EmaCrossConfig):
        super().__init__(config)
        self.instrument_id = config.instrument_id
        
        # å®šç¾©æŒ‡æ¨™
        self.fast_ema = ExponentialMovingAverage(config.fast_period)
        self.slow_ema = ExponentialMovingAverage(config.slow_period)

    def on_bar(self, bar):
        # æ›´æ–°æŒ‡æ¨™
        self.fast_ema.update(bar.close)
        self.slow_ema.update(bar.close)

        # ç¢ºä¿æŒ‡æ¨™å·²æº–å‚™å¥½
        if not self.fast_ema.initialized or not self.slow_ema.initialized:
            return

        # ç²å–ç•¶å‰æŒå€‰
        pos = self.portfolio.position(self.instrument_id)
        
        # äº¤æ˜“é‚è¼¯
        if self.fast_ema.value &gt; self.slow_ema.value:
            # é»ƒé‡‘äº¤å‰ï¼šè²·å…¥
            if not pos:
                self.buy()
        elif self.fast_ema.value &lt; self.slow_ema.value:
            # æ­»äº¡äº¤å‰ï¼šè³£å‡º
            if pos:
                self.sell_all()

    def buy(self):
        order = self.order_factory.market(
            instrument_id=self.instrument_id,
            order_side=OrderSide.BUY,
            quantity=self.config.trade_size,
        )
        self.submit_order(order)

    def sell_all(self):
        self.close_all_positions(self.instrument_id)</code></pre>
<!-- ==================== -->
<h2>æ­¥é©Ÿ 4ï¼šé‹è¡Œå›æ¸¬ (run_backtest.py)</h2>
<pre><code class="language-python">from decimal import Decimal
from nautilus_trader.backtest.engine import BacktestEngine, BacktestEngineConfig
from nautilus_trader.model.instruments import InstrumentId
from nautilus_trader.model.currencies import Currency
from nautilus_trader.model.objects import Money
from nautilus_trader.model.enums import AccountType, OmsType

from strategies.ema_cross import EmaCrossStrategy, EmaCrossConfig

#é…ç½®å›æ¸¬å¼•æ“
config = BacktestEngineConfig(
    strategies=[
        EmaCrossConfig(
            instrument_id="ETHUSDT.BINANCE",
            fast_period=10,
            slow_period=20,
            trade_size="0.1",
        )
    ]
)
engine = BacktestEngine(config=config)

# 1. é…ç½®äº¤æ˜“æ‰€å’Œå¸³æˆ¶
engine.add_venue(
    venue="BINANCE",
    oms_type=OmsType.NETTING,
    account_type=AccountType.MARGIN,
    starting_balances=[Money(10_000, Currency.from_str("USDT"))],
)

# 2. è¼‰å…¥æ•¸æ“š (å¾æˆ‘å€‘å‰›æ‰å»ºç«‹çš„ Catalog)
engine.add_data_from_catalog("./catalog")

# 3. é‹è¡Œå›æ¸¬
engine.run()

# 4. è¼¸å‡ºçµæœ
engine.trader.generate_account_report("BINANCE")
print("å›æ¸¬å®Œæˆï¼")

# 5. ç”Ÿæˆ Tearsheet (å¯é¸ï¼Œéœ€å®‰è£ quantstats)
# é€™è£¡å±•ç¤ºç°¡æ˜“çµæœ
portfolio = engine.trader.portfolio
print(f"æœ€çµ‚æ¬Šç›Š: {portfolio.account('BINANCE').balance_total(Currency.from_str('USDT'))}")
</code></pre>
<!-- ==================== -->
<h2>ä½œæ¥­</h2>
<div class="exercise-block">
<div class="exercise-title">ğŸ“ æŒ‘æˆ°ä»»å‹™</div>
<p>1. ä¿®æ”¹ä¸Šé¢çš„ä»£ç¢¼ï¼ŒåŠ å…¥ <code>FeeModel</code>ï¼ˆMaker 0.02%, Taker 0.04%ï¼‰ã€‚</p>
<p>2. ä¿®æ”¹ç­–ç•¥ï¼ŒåŠ å…¥æ­¢æé‚è¼¯ï¼ˆä¾‹å¦‚ï¼šå¦‚æœè™§æè¶…é 2% å‰‡å¼·åˆ¶å¹³å€‰ï¼‰ã€‚</p>
<p>3. å˜—è©¦åœ¨å›æ¸¬ä¸­åŠ å…¥ç¬¬äºŒå€‹å“ç¨®ï¼ˆä¾‹å¦‚ BTCUSDTï¼‰ï¼Œä¸¦è®“ç­–ç•¥åŒæ™‚äº¤æ˜“å…©å€‹å“ç¨®ã€‚</p>
</div>
<div class="page-nav">
<a href="../Module_17_Advanced_Topics/index.html"><span class="nav-label">â† ä¸Šä¸€ç« </span><span class="nav-title">æ¨¡çµ„ 17ï¼šé€²éšä¸»é¡Œ</span></a>
<a href="../Lab_02_Binance_Sandbox/index.html" style="text-align:right;"><span class="nav-label">ä¸‹ä¸€ç« 
                            â†’</span><span class="nav-title">Lab 02ï¼šæ¥å…¥ Binance æ²™ç®±</span></a>
</div>
</div>
</div>
</div>
<button aria-label="å›åˆ°é ‚éƒ¨" class="back-to-top">â†‘</button>
<script src="../assets/lecture.js"></script>
</body>
</html>