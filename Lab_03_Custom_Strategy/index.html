<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab 03ï¼šè‡ªå®šç¾©æŒ‡æ¨™èˆ‡ç­–ç•¥ â€” NautilusTrader æ•™æ</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/style.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>

<body>
    <div class="page-wrapper">
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo"><span class="icon">ğŸš</span> NautilusTrader æ•™æ</div>
            </div>
            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">ç¬¬é›¶éšæ®µï¼šèµ·æ­¥</div>
                </div>
                <!-- ... omitted -> will be filled by script ... -->
                <a class="nav-item" href="../Module_00_Getting_Started/index.html"><span class="nav-num">00</span>
                    ç’°å¢ƒå®‰è£</a>
                <div class="nav-section">
                    <div class="nav-section-title">ç¬¬ä¸€éšæ®µï¼šå…¨å±€èªè­˜</div>
                </div>
                <a class="nav-item" href="../Module_01_Why_NautilusTrader/index.html"><span class="nav-num">01</span>
                    ç‚ºä»€éº¼é¸æ“‡ NT</a>
                <a class="nav-item" href="../Module_02_Architecture_Overview/index.html"><span class="nav-num">02</span>
                    æ¶æ§‹é³¥ç°åœ–</a>
                <a class="nav-item" href="../Module_03_Design_Philosophy/index.html"><span class="nav-num">03</span>
                    è¨­è¨ˆå“²å­¸</a>
                <div class="nav-section">
                    <div class="nav-section-title">ç¬¬äºŒéšæ®µï¼šæ ¸å¿ƒçµ„ä»¶</div>
                </div>
                <a class="nav-item" href="../Module_04_Domain_Model/index.html"><span class="nav-num">04</span> é ˜åŸŸæ¨¡å‹</a>
                <a class="nav-item" href="../Module_05_MessageBus/index.html"><span class="nav-num">05</span> æ¶ˆæ¯ç¸½ç·š</a>
                <a class="nav-item" href="../Module_05B_Data_Management/index.html"><span class="nav-num">05B</span>
                    æ•¸æ“šç®¡ç†</a>
                <a class="nav-item" href="../Module_06_Cache/index.html"><span class="nav-num">06</span> ç·©å­˜ç³»çµ±</a>
                <a class="nav-item" href="../Module_07_DataEngine/index.html"><span class="nav-num">07</span> æ•¸æ“šå¼•æ“</a>
                <a class="nav-item" href="../Module_08_ExecutionEngine/index.html"><span class="nav-num">08</span>
                    åŸ·è¡Œå¼•æ“</a>
                <a class="nav-item" href="../Module_09_RiskEngine/index.html"><span class="nav-num">09</span> é¢¨æ§å¼•æ“</a>
                <a class="nav-item" href="../Module_10_Portfolio/index.html"><span class="nav-num">10</span> æŠ•è³‡çµ„åˆ</a>
                <div class="nav-section">
                    <div class="nav-section-title">ç¬¬ä¸‰éšæ®µï¼šå¯¦æˆ°æ‡‰ç”¨</div>
                </div>
                <a class="nav-item" href="../Module_11_Strategy_Development/index.html"><span class="nav-num">11</span>
                    ç­–ç•¥é–‹ç™¼</a>
                <a class="nav-item" href="../Module_12_Backtest_And_Live/index.html"><span class="nav-num">12</span>
                    å›æ¸¬èˆ‡å¯¦ç›¤</a>
                <div class="nav-section">
                    <div class="nav-section-title">ç¬¬å››éšæ®µï¼šé€²éšæ“´å±•</div>
                </div>
                <a class="nav-item" href="../Module_13_Adapters_Extensions/index.html"><span class="nav-num">13</span>
                    é©é…å™¨èˆ‡æ“´å±•</a>
                <a class="nav-item" href="../Module_14_Configuration/index.html"><span class="nav-num">14</span>
                    é…ç½®ç³»çµ±æ·±æ½›</a>
                <a class="nav-item" href="../Module_15_Live_Advanced/index.html"><span class="nav-num">15</span>
                    å¯¦ç›¤éƒ¨ç½²é€²éš</a>
                <a class="nav-item" href="../Module_16_Accounting_Risk/index.html"><span class="nav-num">16</span>
                    æœƒè¨ˆèˆ‡é¢¨æ§</a>
                <a class="nav-item" href="../Module_17_Advanced_Topics/index.html"><span class="nav-num">17</span>
                    é€²éšä¸»é¡Œ</a>
                <div class="nav-section">
                    <div class="nav-section-title">ç¬¬äº”éšæ®µï¼šå‹•æ‰‹ Lab</div>
                </div>
                <a class="nav-item" href="../Lab_01_Backtest_Workflow/index.html"><span class="nav-num">L1</span> Lab
                    01</a>
                <a class="nav-item" href="../Lab_02_Binance_Sandbox/index.html"><span class="nav-num">L2</span> Lab
                    02</a>
                <a class="nav-item active" href="index.html"><span class="nav-num">L3</span> Lab 03</a>
            </div>
        </nav>

        <div class="main-content">
            <div class="top-bar">
                <button class="menu-toggle" aria-label="é–‹å•Ÿé¸å–®">â˜°</button>
                <div class="breadcrumb"><a href="../index.html">é¦–é </a><span class="separator">â€º</span>ç¬¬äº”éšæ®µ<span
                        class="separator">â€º</span>Lab 03</div>
            </div>
            <div class="content-container">

                <span class="phase-label phase-5">ç¬¬äº”éšæ®µï¼šå‹•æ‰‹ Lab</span>
                <h1>Lab 03ï¼šè‡ªå®šç¾©æŒ‡æ¨™èˆ‡ç­–ç•¥<span class="subtitle">å‹•æ‰‹å¯¦ä½œï¼šæ‰“é€ å°ˆå±¬æ–¼ä½ çš„ç¨å®¶æŒ‡æ¨™</span></h1>

                <!-- ==================== -->
                <h2>ç›®æ¨™</h2>
                <ol>
                    <li>å­¸ç¿’å¦‚ä½•ç¹¼æ‰¿ <code>Indicator</code> åŸºé¡</li>
                    <li>å¯¦ç¾ä¸€å€‹ <strong>Z-Score</strong> æŒ‡æ¨™ï¼ˆå‡å€¼å›æ­¸å¸¸ç”¨ï¼‰</li>
                    <li>å°‡æŒ‡æ¨™æ•´åˆé€² <code>Strategy</code></li>
                    <li>ç·¨å¯«åŸºæ–¼ Z-Score çš„ Bolinger Band ç­–ç•¥é‚è¼¯</li>
                </ol>

                <!-- ==================== -->
                <h2>æ­¥é©Ÿ 1ï¼šå¯¦ç¾ Z-Score æŒ‡æ¨™</h2>
                <p>Z-Score = (ç•¶å‰åƒ¹æ ¼ - å¹³å‡å€¼) / æ¨™æº–å·®ã€‚<br>
                    å®ƒåæ˜ åƒ¹æ ¼åé›¢å‡å€¼çš„ç¨‹åº¦ï¼Œé€šå¸¸è¶…é +2 æˆ–ä½æ–¼ -2 è¦–ç‚ºè¶…è²·/è¶…è³£ã€‚</p>

                <pre><code class="language-python">from nautilus_trader.indicators.base.indicator import Indicator
from nautilus_trader.indicators.average.sma import SimpleMovingAverage
from nautilus_trader.indicators.volatility.std_dev import StandardDeviation

class ZScore(Indicator):
    def __init__(self, period: int):
        super().__init__()  # å¿…é ˆèª¿ç”¨çˆ¶é¡æ§‹é€ å‡½æ•¸
        self.period = period
        
        # çµ„åˆç¾æœ‰æŒ‡æ¨™
        self.sma = SimpleMovingAverage(period)
        self.std = StandardDeviation(period)
        
        self._value = 0.0

    @property
    def value(self) -> float:
        return self._value

    @property
    def initialized(self) -> bool:
        return self.sma.initialized and self.std.initialized

    def update(self, price: float):
        # 1. æ›´æ–°å…§éƒ¨æŒ‡æ¨™
        self.sma.update(price)
        self.std.update(price)

        # 2. å¦‚æœå…§éƒ¨æŒ‡æ¨™æœªåˆå§‹åŒ–ï¼Œç›´æ¥è¿”å›
        if not self.initialized:
            return

        # 3. è¨ˆç®— Z-Score
        # é˜²æ­¢é™¤ä»¥é›¶
        if self.std.value == 0:
            self._value = 0.0
        else:
            self._value = (price - self.sma.value) / self.std.value
            
        # 4. è§¸ç™¼æ›´æ–°äº‹ä»¶ï¼ˆå¯é¸ï¼Œå¦‚æœå…¶ä»–çµ„ä»¶è¨‚é–±äº†æ­¤æŒ‡æ¨™ï¼‰
        self._set_value(self._value)</code></pre>

                <div class="callout callout-info">
                    <div class="callout-title">ğŸ’¡ çµ„åˆ vs ç¹¼æ‰¿</div>
                    <p>é€™è£¡æ˜¯<strong>çµ„åˆ (Composition)</strong> çš„æœ€ä½³ç¯„ä¾‹ã€‚æˆ‘å€‘æ²’æœ‰å¾é›¶è¨ˆç®—å‡å€¼å’Œæ¨™æº–å·®ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨äº†ç¾æœ‰çš„ SMA å’Œ StdDev
                        æŒ‡æ¨™ã€‚é€™æ¨£ä»£ç¢¼æ›´ç°¡æ½”ã€æ›´ä¸å®¹æ˜“å‡ºéŒ¯ã€‚</p>
                </div>

                <!-- ==================== -->
                <h2>æ­¥é©Ÿ 2ï¼šç·¨å¯« Mean Reversion ç­–ç•¥</h2>
                <p>ç­–ç•¥é‚è¼¯ï¼š</p>
                <ul>
                    <li>Z-Score > 2.0ï¼šåƒ¹æ ¼éé«˜ï¼Œåšç©º</li>
                    <li>Z-Score < -2.0ï¼šåƒ¹æ ¼éä½ï¼Œåšå¤š</li>
                    <li>Z-Score å›æ­¸åˆ° 0 é™„è¿‘ï¼ˆå¦‚ -0.5 ~ 0.5ï¼‰ï¼šå¹³å€‰</li>
                </ul>

                <pre><code class="language-python">from nautilus_trader.trading.strategy import Strategy
from nautilus_trader.config import StrategyConfig
from nautilus_trader.model.enums import OrderSide

class MeanReversionConfig(StrategyConfig):
    instrument_id: str
    period: int = 20
    entry_z: float = 2.0
    exit_z: float = 0.5
    trade_size: str = "0.01"

class MeanReversionStrategy(Strategy):
    def __init__(self, config: MeanReversionConfig):
        super().__init__(config)
        
        # å¯¦ä¾‹åŒ–æˆ‘å€‘çš„è‡ªå®šç¾©æŒ‡æ¨™
        self.z_score = ZScore(config.period)

    def on_bar(self, bar):
        # æ›´æ–°æŒ‡æ¨™
        self.z_score.update(bar.close)

        if not self.z_score.initialized:
            return
            
        z = self.z_score.value
        self.log.info(f"Z-Score: {z:.2f}")

        # ç²å–æŒå€‰
        pos = self.portfolio.position(self.config.instrument_id)
        
        # --- é€²å ´é‚è¼¯ ---
        if not pos:
            if z < -self.config.entry_z:
                # åƒ¹æ ¼éä½ -> è²·å…¥
                self.buy()
            elif z > self.config.entry_z:
                # åƒ¹æ ¼éé«˜ -> è³£å‡º
                self.sell()
                
        # --- å‡ºå ´é‚è¼¯ ---
        else:
            if pos.is_long and z > -self.config.exit_z:
                # å¤šå–®ï¼šå›æ­¸åˆ°å‡ç·šä¸‹æ–¹é™„è¿‘ -> å¹³å€‰
                self.close_all_positions(self.config.instrument_id)
            elif pos.is_short and z < self.config.exit_z:
                # ç©ºå–®ï¼šå›æ­¸åˆ°å‡ç·šä¸Šæ–¹é™„è¿‘ -> å¹³å€‰
                self.close_all_positions(self.config.instrument_id)

    def buy(self):
        order = self.order_factory.market(
            instrument_id=self.config.instrument_id,
            order_side=OrderSide.BUY,
            quantity=self.config.trade_size,
        )
        self.submit_order(order)

    def sell(self):
        order = self.order_factory.market(
            instrument_id=self.config.instrument_id,
            order_side=OrderSide.SELL,
            quantity=self.config.trade_size,
        )
        self.submit_order(order)</code></pre>

                <!-- ==================== -->
                <h2>æ­¥é©Ÿ 3ï¼šå›æ¸¬é©—è­‰</h2>
                <p>ç¾åœ¨ä½ å¯ä»¥æŠŠé€™å€‹ç­–ç•¥æ”¾åˆ° Lab 01 çš„ <code>run_backtest.py</code> ä¸­é‹è¡Œï¼Œçœ‹çœ‹å‡å€¼å›æ­¸ç­–ç•¥åœ¨ ETHUSDT ä¸Šçš„è¡¨ç¾å¦‚ä½•ã€‚</p>

                <!-- ==================== -->
                <h2>ä½œæ¥­</h2>
                <div class="exercise-block">
                    <div class="exercise-title">ğŸ“ æŒ‘æˆ°ä»»å‹™</div>
                    <p>1. å˜—è©¦ä¿®æ”¹ ZCheck æŒ‡æ¨™ï¼ŒåŠ å…¥ã€Œå‹•é‡éæ¿¾ã€ï¼šåªæœ‰ç•¶ RSI åŒæ™‚è™•æ–¼è¶…è³£å€ï¼ˆ<30ï¼‰æ™‚ï¼Œæ‰ç™¼å‡ºåšå¤šä¿¡è™Ÿï¼ˆZ < -2ï¼‰ã€‚</p>
                            <p>2. å˜—è©¦å°‡æ­¤ç­–ç•¥éƒ¨ç½²åˆ° Lab 02 çš„æ²™ç®±ç’°å¢ƒä¸­ï¼Œè§€å¯Ÿå¯¦æ™‚é‹è¡Œçš„æ•ˆæœã€‚</p>
                            <p>3. é€²éšæŒ‘æˆ°ï¼šå¯¦ç¾ä¸€å€‹ <code>SuperTrend</code> æŒ‡æ¨™ï¼ˆéœ€è¦è¨ˆç®— ATRï¼‰ã€‚</p>
                </div>

                <div class="page-nav">
                    <a href="../Lab_02_Binance_Sandbox/index.html"><span class="nav-label">â† ä¸Šä¸€ç« </span><span
                            class="nav-title">Lab 02ï¼šæ¥å…¥ Binance æ²™ç®±</span></a>
                    <a href="../index.html" style="text-align:right;"><span class="nav-label">å›åˆ°é¦–é </span><span
                            class="nav-title">å®Œçµæ’’èŠ± ğŸ‰</span></a>
                </div>
            </div>
        </div>
    </div>
    <button class="back-to-top" aria-label="å›åˆ°é ‚éƒ¨">â†‘</button>
    <script src="../assets/lecture.js"></script>
</body>

</html>